<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>QGチャット</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>

      :root {
        --sidebar-w: 280px;
        --results-w: 800px;  /* ← 320px から 640px に拡大 */
      }

    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; margin: 0; color: #111; background: #f6f6f6; }
    .app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; height: 100vh; overflow: hidden; }

    /* 左ペイン（会話/資料） */
    aside { background: #fff; border-right: 1px solid #e5e5e5; display: grid; grid-template-rows: auto 50vh 1fr; min-height: 0; }
    .aside-header { padding: 12px; border-bottom: 1px solid #eee; display: flex; gap: 8px; align-items: center; }
    .btn { padding: 8px 10px; border: 1px solid #ddd; background: #fafafa; border-radius: 6px; cursor: pointer; }
    .btn.primary { background: #2f6feb; color: #fff; border-color: #2f6feb; }
    .userline { margin-left: auto; font-size: 12px; color: #555; }
    .conv-section { display: flex; flex-direction: column; min-height: 0; border-bottom: 1px solid #eee; }
    .conv-section-title { font-size: 12px; color: #666; padding: 8px 12px; border-bottom: 1px solid #f2f2f2; }
    .conv-list { overflow-y: auto; padding: 8px; min-height: 0; }
    .conv-item { padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fff; margin-bottom: 8px; cursor: pointer; }
    .conv-item:hover { background: #f7f9ff; }
    .conv-item.active { border-color: #2f6feb; background: #eef3ff; }
    .conv-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-meta { font-size: 12px; color: #666; display: flex; gap: 8px; }

    .materials-section { display: flex; flex-direction: column; min-height: 0; border-top: 1px solid #eee; }
    .materials-section-title { font-size: 12px; color: #666; padding: 8px 12px; border-bottom: 1px solid #f2f2f2; }
    .materials-list { overflow-y: auto; padding: 8px; }
    .material-item { padding: 8px 10px; border: 1px solid #eee; border-radius: 6px; background: #fff; margin-bottom: 6px; font-size: 12px; }

    /* 右ペインを含むメイン領域 */
    main { display: grid; grid-template-rows: auto 1fr; height: 100%; min-height: 0; } 
    header { background: #fff; padding: 12px 16px; border-bottom: 1px solid #e5e5e5; display: grid; grid-template-columns: 1fr var(--results-w); align-items: center; gap: 8px; }
    header .title { display: flex; align-items: center; gap: 8px; }
    header .spacer { flex: 1; }
    #convMeta { font-size: 12px; color: #555; }
    .header-right { justify-self: end; }

    /* 本体2カラム（中央=チャット / 右=結果） */
    
    .content {
      display: grid;
      grid-template-columns: 1fr var(--results-w); /* ← 残りは1frでチャットに配分 */
      min-height: 0;
    }
    .chat-col {
      min-width: 0;
      min-height: 0;          /* ← これが無いと子の overflow が効かない */
      display: flex;          /* 子の .chat を縦に伸縮させる */
    }


      /* 結果サイドバー側も保険で */
      .results-col {
        border-left: 1px solid #e5e5e5;
        background: #fafafa;
        min-width: 0;
        min-height: 0;          /* 念のため */
        display: grid;
        grid-template-rows: auto 1fr;
      }
      .results-list { padding: 12px; }
      .result-card { padding: 12px; }

    /* チャット（中央に寄せる） */
    .chat { padding: 16px; overflow-y: auto; height: 100%; }
    .chat-inner { max-width: 900px; margin: 0 auto; }
    #messages {}
    .msg { padding: 10px 12px; margin: 10px 0; border-radius: 10px; line-height: 1.6; white-space: pre-wrap; max-width: 80%; }
    .msg.user { background: #e6f0ff; margin-left: auto; }
    .msg.assistant { background: #fff; border: 1px solid #eee; margin-right: auto; }

    /* シナリオUI（中央カラム内） */
    .scenario { margin: 8px 0 0; }
    .scenario .hint { font-size: 13px; color: #666; margin-bottom: 8px; }
    .scenario-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .scenario-btn { border: 1px solid #ddd; background: #fff; border-radius: 8px; padding: 12px; cursor: pointer; text-align: left; }
    .scenario-btn:hover { background: #f7f9ff; border-color: #cbd6ff; }
    .back-btn { border: 1px solid #ddd; background: #fafafa; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
    .back-btn[disabled] { opacity: .5; cursor: not-allowed; }

    /* 生成結果サイドバー（右） */
    .results-header { padding: 10px 12px; font-size: 12px; color: #666; border-bottom: 1px solid #e5e5e5; background: #fff; }
    .results-list { overflow-y: auto; padding: 8px; }
    .results-course { margin-bottom: 12px; }
    .results-course-title { font-size: 12px; color: #666; padding: 6px 8px; }
    .result-card { padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fff; margin-bottom: 8px; }
    .result-card .name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .result-card .meta { font-size: 12px; color: #666; margin-bottom: 6px; }
    .result-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <div class="app">
    <!-- 左サイドバー -->
    <aside>
      <div class="aside-header">
        <button id="new" class="btn primary">新規会話</button>
        <span id="userInfo" class="userline"></span>
      </div>
      <section class="conv-section">
        <div class="conv-section-title">会話履歴</div>
        <div id="convList" class="conv-list"></div>
      </section>
      <section class="materials-section">
        <div class="materials-section-title">資料一覧</div>
        <div id="materialsList" class="materials-list"></div>
      </section>
    </aside>

    <!-- 右側（ヘッダ＋中央/結果 2カラム） -->
    <main>
      <header>
        <div class="title">
          <strong>QGChat</strong>
          <span id="convMeta" class="muted"></span>
        </div>
        <div class="header-right">
          <button id="logout" class="btn">ログアウト</button>
        </div>
      </header>

      <div class="content">
        <!-- 中央：チャット -->
        <div class="chat-col">
          <div class="chat" id="chatScroll">
            <div class="chat-inner">
              <div id="messages"></div>
              <div id="scenario" class="scenario" style="display:block;"></div>
            </div>
          </div>
        </div>

        <!-- 右：生成結果サイドバー -->
        <div class="results-col">
          <div class="results-header">生成結果（講義ごと）</div>
          <div id="resultsPanel" class="results-list"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const apiBase = location.origin;
    let currentUser = null, conversationId = null, conversations = [];

    const $userInfo = document.getElementById("userInfo");
    const $convList = document.getElementById("convList");
    const $convMeta = document.getElementById("convMeta");
    const $messages = document.getElementById("messages");
    const $chatScroll = document.getElementById("chatScroll");
    const $scenario = document.getElementById("scenario");
    const $materialsList = document.getElementById("materialsList");
    const $resultsPanel = document.getElementById("resultsPanel");

    /* ユーティリティ */
    function fmtDate(iso) {
      try { const d = new Date(iso);
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      } catch { return iso; }
    }
    function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    function appendMessage(role, content) {
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.textContent = content;
      $messages.appendChild(div);
      $chatScroll.scrollTop = $chatScroll.scrollHeight;
    }
    function clearScenario() { $scenario.innerHTML = ""; }

    async function setScenarioState(id, metaPatch) {
      await fetch(`${apiBase}/api/scenario`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ conversationId, id, metaPatch })
      });
    }
    async function getScenarioState() {
      const res = await fetch(`${apiBase}/api/scenario?conversationId=${conversationId}`, { credentials: "include" });
      if (!res.ok) return { id: "root", meta: {} };
      return await res.json();
    }

    function mkBtn(text, onClick){ const b=document.createElement("button"); b.className="scenario-btn"; b.textContent=text; b.onclick=onClick; return b; }

    async function refreshMaterials(){
      const res = await fetch(`${apiBase}/api/materials`, {credentials:"include"});
      const items = res.ok ? await res.json() : [];
      $materialsList.innerHTML="";
      for(const f of items){
        const li=document.createElement("div");
        li.className="material-item";
        li.textContent=f.name||f.id;
        $materialsList.appendChild(li);
      }
    }

    /* root */
    function renderScenarioRoot(){
      clearScenario(); appendMessage("assistant","こんにちは、QGアシスタントです。");
      const wrap=document.createElement("div"); wrap.className="scenario";
      const grid=document.createElement("div"); grid.className="scenario-grid"; wrap.appendChild(grid);
      const b1=mkBtn("1　アップロード済みの資料から問題を作成する",async()=>{
        appendMessage("user","1　アップロード済みの資料から問題を作成する");
        await setScenarioState("1"); renderScenario1();
      });
      const b2=mkBtn("2　新規資料をアップロードし問題を作成する",async()=>{
        appendMessage("user","2　新規資料をアップロードし問題を作成する");
        await setScenarioState("2"); renderScenario2();
      });
      grid.append(b1,b2); $scenario.appendChild(wrap);
    }

    /* 1：既存資料 */
    function renderScenario1(){
      clearScenario(); appendMessage("assistant","どの資料から問題を作成しますか？");
      const wrap=document.createElement("div"); wrap.className="scenario";
      const grid=document.createElement("div"); grid.className="scenario-grid"; wrap.appendChild(grid);
      (async()=>{
        const res=await fetch(`${apiBase}/api/materials`,{credentials:"include"});
        const items=res.ok?await res.json():[];
        for(const it of items){
          const b=mkBtn(it.name||it.id,async()=>{
            appendMessage("user",it.name||it.id);
            await setScenarioState("1-course",{docId:it.id,docTitle:it.name||it.id});
            renderCourseInput({from:"1"});
          });
          grid.appendChild(b);
        }
      })();
      const back=document.createElement("button"); back.className="back-btn"; back.textContent="前に戻る";
      back.onclick=async()=>{await setScenarioState("root");renderScenarioRoot();};
      wrap.append(grid,back); $scenario.appendChild(wrap);
    }

    /* 2：アップロード */
    function renderScenario2(){
      clearScenario(); appendMessage("assistant","ファイルをアップロードしてください");
      const wrap=document.createElement("div"); wrap.className="scenario"; const row=document.createElement("div"); row.className="row";
      const input=document.createElement("input"); input.type="file"; input.accept="video/*";
      const up=document.createElement("button"); up.className="btn primary"; up.textContent="アップロード";
      const back=document.createElement("button"); back.className="back-btn"; back.textContent="前に戻る";
      back.onclick=async()=>{await setScenarioState("root");renderScenarioRoot();};
      up.onclick=async()=>{
        if(!input.files||!input.files[0])return;
        back.disabled=up.disabled=true;
        try{
          const fd=new FormData(); fd.append("file",input.files[0]);
          const res=await fetch(`${apiBase}/api/upload`,{method:"POST",credentials:"include",body:fd});
          const data=res.ok?await res.json():null;
          await refreshMaterials();
          await setScenarioState("2-1",{docId:data?.doc?.id,docTitle:data?.doc?.name});
          renderScenario2_1();
        }catch{appendMessage("assistant","アップロードに失敗しました");}
        finally{back.disabled=up.disabled=false;}
      };
      row.append(input,up,back); wrap.appendChild(row); $scenario.appendChild(wrap);
    }

    /* 2-1：生成方法選択 */
    function renderScenario2_1(){
      clearScenario(); appendMessage("assistant","問題生成の方法を選んでください");
      const wrap=document.createElement("div"); wrap.className="scenario"; const grid=document.createElement("div"); grid.className="scenario-grid";
      const p1=mkBtn("パターン1：アップロードされたファイルから作る",async()=>{
        appendMessage("user","パターン1：アップロードされたファイルから作る");
        await setScenarioState("2-course",{lastPattern:1});
        renderCourseInput({from:"2",pattern:1});
      });
      const p2=mkBtn("パターン2：分析してトピック指定で作る",async()=>{
        appendMessage("user","パターン2：分析してトピック指定で作る");
        await setScenarioState("2-course",{lastPattern:2});
        renderCourseInput({from:"2",pattern:2});
      });
      const p3=mkBtn("パターン3：他のファイルも追加して複数から作る",async()=>{
        appendMessage("user","パターン3：他のファイルも追加して複数から作る");
        await setScenarioState("2-course",{lastPattern:3});
        renderCourseInput({from:"2",pattern:3});
      });
      const cancel=mkBtn("やめる（rootへ戻る）",async()=>{await setScenarioState("root");renderScenarioRoot();});
      grid.append(p1,p2,p3,cancel); wrap.appendChild(grid); $scenario.appendChild(wrap);
    }

    /* 授業名入力 */
    async function renderCourseInput({from,pattern}={}){
      clearScenario(); appendMessage("assistant","授業名を入力してください（例：情報ネットワーク）");
      const wrap=document.createElement("div"); wrap.className="scenario"; const row=document.createElement("div"); row.className="row";
      const input=document.createElement("input"); input.type="text"; input.placeholder="授業名を入力"; input.style.minWidth="260px";
      const ok=document.createElement("button"); ok.className="btn primary"; ok.textContent="決定";
      const back=document.createElement("button"); back.className="back-btn"; back.textContent="前に戻る";
      back.onclick=async()=>{if(from==="1"){await setScenarioState("1");renderScenario1();}else{await setScenarioState("2-1");renderScenario2_1();}};
      ok.onclick=async()=>{
        const name=(input.value||"").trim();
        if(!name){appendMessage("assistant","授業名を入力してください。");return;}
        await setScenarioState(from==="1"?"1-1":(pattern===1?"2-2":pattern===2?"2-3":"2-4"),{courseName:name});
        if(from==="1"){
          appendMessage("assistant",`授業名「${name}」を保存しました。（1-1未実装）`);
        }else{
          if(pattern===1) renderScenario2_2();
          else appendMessage("assistant","未実装パターンです。");
        }
      };
      row.append(input,ok,back); wrap.appendChild(row); $scenario.appendChild(wrap);
    }

    /* 2-2：問題生成→保存→一覧更新 */
    function renderScenario2_2(){
      clearScenario(); appendMessage("assistant","アップロードされた資料から問題を生成します。");
      const wrap=document.createElement("div"); wrap.className="scenario";
      const log=document.createElement("div"); log.className="hint"; log.textContent="開始";
      wrap.appendChild(log); $scenario.appendChild(wrap);
      (async()=>{
        await fetch(`${apiBase}/api/process/start`,{
          method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",
          body:JSON.stringify({conversationId,mode:"full"})
        });
        const timer=setInterval(async()=>{
          const r=await fetch(`${apiBase}/api/process/progress?conversationId=${conversationId}`,{credentials:"include"});
          if(!r.ok) return;
          const p=await r.json();
          log.textContent = p.message || (
            p.stage==="analysis" ? "内容分析処理中" :
            p.stage==="qa"       ? "問題生成処理中" :
            "完了"
          );
          if(p.stage==="done"){
            clearInterval(timer);
            await fetch(`${apiBase}/api/results`,{
              method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",
              body:JSON.stringify({conversationId,pattern:1})
            });
            await setScenarioState("2-5");
            renderResultsPanel();
          }
        },1500);
      })();
    }

    /* 右サイド：結果一覧（講義ごとに縦リスト） */
async function renderResultsPanel(){
  try{
    const res = await fetch(`${apiBase}/api/qa`, { credentials:"include" });
    const items = res.ok ? await res.json() : [];

    // 講義ごとにグループ化
    const groups = new Map();
    for(const it of items){
      if(!groups.has(it.course_name)) groups.set(it.course_name, []);
      groups.get(it.course_name).push(it);
    }

    $resultsPanel.innerHTML = "";
    for(const [course, rows] of groups){
      const sec = document.createElement("div"); sec.className="results-course";
      const title = document.createElement("div"); title.className="results-course-title"; title.textContent = course; 
      sec.appendChild(title);

      for(const r of rows){
        const card = document.createElement("div"); card.className="result-card";
        const name = document.createElement("div"); name.className="name";
        name.textContent = `${r.video_name} / ${r.identifier}`;
        const meta = document.createElement("div"); meta.className="meta";
        meta.textContent = `${new Date(r.latest).toLocaleString()} / ${r.q_count}問`;

        const actions = document.createElement("div"); actions.className="result-actions";
        const preview = document.createElement("button"); preview.className="btn"; preview.textContent="プレビュー";
        preview.onclick = async () => {
          try{
            const rr = await fetch(`${apiBase}/api/qa/detail?identifier=${encodeURIComponent(r.identifier)}`, { credentials:"include" });
            const detail = rr.ok ? await rr.json() : [];
            showQAPreview(detail);
          }catch(e){}
        };
        actions.append(preview);

        card.append(name, meta, actions);
        sec.appendChild(card);
      }

      $resultsPanel.appendChild(sec);
    }
  }catch{
    // 失敗時はスキップ
  }
}

    /* 認証/会話 */
    async function requireLogin() {
      const res = await fetch("/api/me", { credentials: "include" });
      const data = await res.json();
      if (!data.user) { location.href = "/login"; return null; }
      return data.user;
    }
    async function fetchConversations() {
      const res = await fetch(`${apiBase}/api/conversations`, { credentials: "include" });
      conversations = res.ok ? await res.json() : [];
      await pruneOldConversationsIfNeeded();
      renderConvList();
    }
    async function pruneOldConversationsIfNeeded() {
      if (conversations.length <= 20) return;
      const toDelete = [...conversations].sort((a,b)=>new Date(a.created_at)-new Date(b.created_at)).slice(0, conversations.length - 20);
      for (const c of toDelete) {
        try {
          const res = await fetch(`${apiBase}/api/conversations/${c.id}`, { method: "DELETE", credentials: "include" });
          if (res.ok) {
            conversations = conversations.filter(x => x.id !== c.id);
            if (conversationId === c.id) { conversationId = null; $messages.innerHTML = ""; $convMeta.textContent = ""; }
          }
        } catch {}
      }
    }
    function renderConvList() {
      $convList.innerHTML = "";
      for (const c of conversations) {
        const item = document.createElement("div");
        item.className = "conv-item" + (c.id === conversationId ? " active" : "");
        const title = c.title || "新規チャット";
        item.innerHTML = `
          <div class="conv-title" title="${escapeHTML(title)}">${escapeHTML(title)}</div>
          <div class="conv-meta"><span>#${c.id}</span><span>${fmtDate(c.created_at)}</span></div>
        `;
        item.addEventListener("click", () => { if (conversationId !== c.id) loadConversation(c.id); });
        $convList.appendChild(item);
      }
    }
    async function loadConversation(id) {
      const res = await fetch(`${apiBase}/api/conversations/${id}`, { credentials: "include" });
      if (!res.ok) return;
      const data = await res.json();
      conversationId = data.id;
      $convMeta.textContent = ``;

      // メッセージ
      $messages.innerHTML = "";
      let hasUser = false;
      for (const m of data.messages) {
        appendMessage(m.role, m.content);
        if (m.role === "user") hasUser = true;
      }

      // 右サイド更新
      await renderResultsPanel();

      // 状態に応じて描画
      const st = await getScenarioState();
      switch (st.id) {
        case "1": renderScenario1(); break;
        case "2": renderScenario2(); break;
        case "2-1": renderScenario2_1(); break;
        case "2-2": renderScenario2_2(); break;
        case "1-course": renderCourseInput({from:"1"}); break;
        case "2-course": renderCourseInput({from:"2", pattern: st.meta?.lastPattern}); break;
        case "2-5": default:
          if (!hasUser) renderScenarioRoot();
      }

      renderConvList();
    }
    async function createConversation() {
      const res = await fetch(`${apiBase}/api/conversations`, {
        method: "POST", headers: { "Content-Type": "application/json" }, credentials: "include",
        body: JSON.stringify({ title: "新規チャット" })
      });
      const data = await res.json();
      conversations.unshift({ id: data.id, title: data.title, created_at: data.created_at });
      await pruneOldConversationsIfNeeded();
      renderConvList();

      await loadConversation(data.id);
      await setScenarioState("root");
      renderScenarioRoot();
    }

    /* イベント/初期化 */
    document.getElementById("logout").addEventListener("click", async () => {
      await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
      location.href = "/login";
    });
    document.getElementById("new").addEventListener("click", createConversation);

    (async () => {
      currentUser = await requireLogin();
      if (!currentUser) return;
      $userInfo.textContent = `${currentUser.username}`;
      await fetchConversations();
      await refreshMaterials();
      await renderResultsPanel();

      if (conversations.length) {
        await loadConversation(conversations[0].id);
      } else {
        await setScenarioState("root");
        renderScenarioRoot();
      }
    })();



    /* 簡易プレビュー（素朴なモーダル） */
function showQAPreview(list){
  const wrap = document.createElement("div");
  wrap.style.position="fixed"; wrap.style.inset="0"; wrap.style.background="rgba(0,0,0,.3)";
  wrap.style.display="flex"; wrap.style.alignItems="center"; wrap.style.justifyContent="center";
  const box = document.createElement("div");
  box.style.background="#fff"; box.style.maxWidth="900px"; box.style.width="90%"; box.style.maxHeight="80vh"; box.style.overflow="auto";
  box.style.padding="16px"; box.style.borderRadius="10px"; box.innerHTML = `<h3 style="margin:0 0 12px">プレビュー</h3>`;
  const ul = document.createElement("div");
  for(const it of list){
    const d = document.createElement("div");
    d.style.border="1px solid #eee"; d.style.borderRadius="8px"; d.style.padding="10px"; d.style.marginBottom="8px";
    d.innerHTML = `<div style="font-weight:600; margin-bottom:6px;">Q. ${escapeHTML(it.question)}</div>
                   <div style="color:#333;">A. ${escapeHTML(it.answer)}</div>`;
    ul.appendChild(d);
  }
  const close = document.createElement("button"); close.className="btn"; close.textContent="閉じる";
  close.onclick = ()=>document.body.removeChild(wrap);
  box.appendChild(ul); box.appendChild(close);
  wrap.appendChild(box); document.body.appendChild(wrap);
}
  </script>
</body>
</html>
